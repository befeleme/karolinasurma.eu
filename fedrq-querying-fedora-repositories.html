<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>fedrq - querying Fedora repositories &ndash; A blog</title>

    <!-- Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="Karo" />
    <meta property="article:section" content="Fedora" />
    <meta property="article:published_time" content="2024-02-29" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="fedrq - querying Fedora repositories"/>
    <meta property="og:description" content="Querying repositories Part of my $DAILYJOB is digging in multiple Fedora repositories. Every time I prepare a package update, I check whether the update has a potential to break something. Typically I set up lists of packages that require my package and build them in a isolated environment, before hitting …"/>
    <meta property="og:site_name" content="A blog" />
    <meta property="og:url" content="https://karolinasurma.eu/fedrq-querying-fedora-repositories.html"/>

    <!-- Feed -->
    <link rel="alternate" type="application/atom+xml" href="https://karolinasurma.eu/feeds/all.atom.xml" title="A blog Atom Feed" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://karolinasurma.eu/theme/css/opensans.css">
    <link rel="stylesheet" type="text/css" href="https://karolinasurma.eu/theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="https://karolinasurma.eu/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://karolinasurma.eu/theme/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://karolinasurma.eu/theme/css/pygments-highlight-github.css">

    <!-- Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://karolinasurma.eu/./images/extra/favicon.ico">

  </head>

  <body>
    <div class="w3-row w3-card w3-white">
      <header id="header">
        <a href="https://karolinasurma.eu/" id="header-logo" title="Home">KS</a>
        <nav id="header-menu">
          <ul>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="/categories.html">Categories</a></li>
            <li class="w3-bottombar w3-border-white w3-hover-border-green"><a href="/archives.html">Archive</a></li>
          </ul>
        </nav>
      </header>
    </div>



    <br><br><br>

    <article>
      <header class="w3-container col-main">
        <h1>fedrq - querying Fedora repositories</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2024-02-29T16:18:00+01:00">Thu 29 February 2024</time> in <a href="https://karolinasurma.eu/category/fedora.html" title="All articles in category Fedora">Fedora</a></span>
          </div>
          <div>
            <span class="w3-tag w3-light-grey w3-text-green w3-hover-green">
              <a href="https://karolinasurma.eu/tag/en.html" title="All articles with En tag">#EN</a>
            </span>
          </div>
        </div>
      </header>

      <br>


      <div class="col-main w3-container">
        <section id="content">
          <h2>Querying repositories</h2>
<p>Part of my $DAILYJOB is digging in multiple Fedora repositories.
Every time I prepare a package update, I check whether the update has a potential to break something.
Typically I set up lists of packages that require my package and build them in a isolated environment, before hitting the real Fedora.
I heavily use Copr as a test bed (described in detail in the talk from <a href="./devconf-2023-packaging-talk.html">DevConf 2023</a>).
In that talk I show and comment a bunch of repoqueries.
Repoqueries do the job, but they're nearly-impossible to come up with (correctly) and if I lost my bash history, I'd be left crying on the floor.
(<em>Not really though</em>, in the end I've got the talk recording \&lt;evil laughter>).</p>
<h2>fedrq</h2>
<p>This is where <a href="https://fedrq.gtmx.me/">fedrq</a> comes to the scene. A new tool with a new approach by an incredibly active Fedora community member, gotmax23.
I spent a jolly day with it and decided to create this cheatsheet to help me translate my use cases to fedrq and ease the migration.</p>
<h2>Cheatsheet</h2>
<h3>formatters</h3>
<p>Powerful feature of the tool; list them all with:</p>
<div class="highlight"><pre><span></span><code>$ fedrq formatters --attrs
</code></pre></div>


<p>And format the output of the tool with <code>-F &lt;formatter&gt;</code>.
Many more things are possible, refer to <a href="https://fedrq.gtmx.me/fedrq1/#formatters_1">the documentation</a>.</p>
<h3>What package does a file belong to?</h3>
<div class="highlight"><pre><span></span><code># Fedora Rawhide
$ fedrq pkgs -P /usr/bin/python3
# Fedora 39 (-b, --branch)
$ fedrq pkgs -b f39 -P /usr/bin/python3
# Koji - format output with name-version-release-repository
$ fedrq pkgs -r @koji:rawhide -P /usr/bin/python3 -F nevrr
# Copr repository (-r, --repo)
$ fedrq pkgs -r @copr:@python/python3.13 -P /usr/bin/python3
</code></pre></div>


<h3>List all files from the package</h3>
<div class="highlight"><pre><span></span><code>$ fedrq pkgs python3-rich -F files
</code></pre></div>


<h3>What's the full package name?</h3>
<div class="highlight"><pre><span></span><code>$ fedrq pkgs python-rich
python-rich-13.7.0-5.fc40.src

$ fedrq pkgs python3-rich
python3-rich-13.7.0-5.fc40.noarch
</code></pre></div>


<h3>What packages will be built from my source component?</h3>
<p>I can also format output to get only names: <code>-F name</code> or full nevr <code>-F nevr</code>; or skip formatter at all.</p>
<div class="highlight"><pre><span></span><code>$ fedrq subpkgs python-sphinx -F nev
python-sphinx-doc-1:7.2.6
python3-sphinx-1:7.2.6
python3-sphinx-latex-1:7.2.6
</code></pre></div>


<h3>The opposite: What source rpm comes my built package from?</h3>
<p>It can take also the base name: <code>python3-sphinx-latex</code>.</p>
<div class="highlight"><pre><span></span><code>$ fedrq pkgs python3-sphinx-latex-1:7.2.6-6.fc40.noarch -F source
python-sphinx
</code></pre></div>


<h3>Provides and requirements of my components</h3>
<div class="highlight"><pre><span></span><code>$ fedrq pkgs python3-sphinx -F provides
python3-sphinx = 1:7.2.6-6.fc40
python-sphinx = 1:7.2.6-6.fc40
python3.12-sphinx = 1:7.2.6-6.fc40
python3.12dist(sphinx) = 7.2.6
python3dist(sphinx) = 7.2.6

# runtime requirements
$ fedrq pkgs python3-rich -F requires
python(abi) = 3.12
(python3.12dist(pygments) &lt; 3~~ with python3.12dist(pygments) &gt;= 2.13)
python3.12dist(markdown-it-py) &gt;= 2.2

# buildtime requirements
$ fedrq pkgs python-rich -F requires
python3-devel
python3dist(packaging)
pyproject-rpm-macros
python3dist(pytest)
python3dist(setuptools)
python3dist(attrs)
python3dist(pip) &gt;= 19
(python3dist(tomli) if python3-devel &lt; 3.11)
python3dist(poetry-core) &gt;= 1
(python3dist(pygments) &lt; 3~~ with python3dist(pygments) &gt;= 2.13)
python3dist(markdown-it-py) &gt;= 2.2
</code></pre></div>


<h3>Dependencies</h3>
<h4>What other packages need my binary package?</h4>
<p><code>whatrequires</code> equals to <code>wr</code>.
<code>whatrequires-src</code> equals to <code>wrsrc</code>.
<code>-s, --src</code> means only source rpms.
<code>-S, --nosrc</code> means exclude source rpms.</p>
<blockquote>
<p>For Python <code>-s/-S</code> may not seem relevant, as source and built components are usually named differently,
but for any other components it's crucial, compare e.g.
<code>$ fedrq pkgs ocrmypdf -S -F requires</code> and
<code>$ fedrq pkgs ocrmypdf -F requires</code></p>
</blockquote>
<p>equivalent to: <code>repoquery -q --repo=rawhide{,-source} --whatrequires python3-rich</code></p>
<div class="highlight"><pre><span></span><code>$ fedrq whatrequires python3-rich

# It can work with virtual provides too!
# don&#39;t use it though, it only matches the literal provides
$ fedrq whatrequires -s &#39;python3dist(rich)&#39; -F name

# released Fedora: both fedora and updates repos
$ fedrq whatrequires --branch f38 python3-rich
</code></pre></div>


<p>Only interested in fedora repo?
equivalent to: <code>repoquery --repo=fedora{,-source} --releasever 38 --whatrequires python3-rich</code></p>
<div class="highlight"><pre><span></span><code>$ fedrq whatrequires --branch f38 --repo @release python3-rich
</code></pre></div>


<h4>What packages require any subpackage of my srpm?</h4>
<p>equivalent to: <code>repoquery -q --repo=rawhide{,-source} --whatrequires python3-sphinx --whatrequires python3-sphinx-latex --whatrequires python-sphinx-doc</code></p>
<div class="highlight"><pre><span></span><code># wrsrc is used with the source package name
$ fedrq wrsrc python-sphinx | wc -l
821

# compared to this - it only takes care about this concrete built package name
$ fedrq wr python3-sphinx | wc -l
815
</code></pre></div>


<h4>What packages require python-sphinx' components on build time?</h4>
<p>equivalent to: <code>repoquery -q --repo=rawhide{,-source} --whatrequires python3-sphinx --whatrequires python3-sphinx-latex --whatrequires python-sphinx-doc | grep 'src$' | pkgname | sort | uniq | wc -l</code></p>
<div class="highlight"><pre><span></span><code>$ fedrq wrsrc -s python-sphinx -F source | wc -l
739
</code></pre></div>


<h4>The Big Python Query</h4>
<p>Get names of the source packages in Koji that require any of the given Python provides - needed for Python rebuilds.</p>
<div class="highlight"><pre><span></span><code>$ repoquery --repo=koji --source --whatrequires &#39;libpython3.12.so.1.0()(64bit)&#39; --whatrequires &#39;python(abi) = 3.12&#39; --whatrequires &#39;python3.12dist(*)&#39; | pkgname | env LANG=en_US.utf-8 sort | uniq
</code></pre></div>


<p>Fedrq equivalent:</p>
<div class="highlight"><pre><span></span><code>fedrq wr --repo=&#39;@koji:rawhide&#39; &#39;python3.12dist(*)&#39; &#39;python(abi) = 3.12&#39; &#39;libpython3.12.so.1.0()(64bit)&#39; -F source | env LANG=en_US.utf-8 sort | uniq
</code></pre></div>


<h3>Nice little things repoquery doesn't provide easily</h3>
<p>Breakdown of the buildtime, runtime deps and their srpm names:</p>
<div class="highlight"><pre><span></span><code>$ fedrq whatrequires --branch f38 python3-rich -F breakdown
</code></pre></div>


<p>Resolve the packages required by rich on runtime.
Same with build time - just change the queried package name</p>
<div class="highlight"><pre><span></span><code>$ fedrq pkgs python3-rich -F requires | fedrq pkgs -iSP
python3-3.12.2-2.fc41.x86_64
python3-markdown-it-py-3.0.0-4.fc40.noarch
python3-pygments-2.17.2-3.fc40.noarch
</code></pre></div>


<p>Print lines matching the required package in packages that require the given package (yeah, I can't explain it).
Useful for finding packages that use aggresive version constraints.
Semantically the same as our notoriously horrible oneliner: <code>for pkg in $(repoquery -q --repo=rawhide{,-source} --whatrequires python3-sphinx); do repoquery -q --repo=rawhide{,-source} --requires $pkg | grep -E '\bsphinx\b' | grep '&lt;' &amp;&amp; echo -e "${pkg}\n"; done</code></p>
<div class="highlight"><pre><span></span><code>$ fedrq wr -F narm:python3-sphinx python3-sphinx | grep &quot;&lt;&quot;
# only interested in runtime? -S means --nosrc
$ fedrq wr -S -F narm:python3-sphinx python3-sphinx | grep &quot;&lt;&quot;
</code></pre></div>
        </section>

        <br><br><br>

        <footer>
          <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href="mailto:w_oczekiwaniu[at]interia.pl"><img class="avatar" src="./images/extra/karo.jpg" onerror="this.src='theme/images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px;">
                  <a href="mailto:w_oczekiwaniu[at]interia.pl"><span id="author-name" class="w3-hover-text-dark-grey">Karo</span></a>
                  <p id="author-story">Hi there! I’m Karo. Whenever not computering, I read yet another book or hike through South Moravia.</p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br>




        </footer>
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-small w3-text-grey w3-padding-48">
        <span>
          &copy;
          2021&dash;2024          Karo
 | <a href="https://karolinasurma.eu/feeds/all.atom.xml">Atom feed <i class="fa fa-rss" aria-hidden="true"></i></a>        </span>
      </div>
    </footer>

  </body>
</html>